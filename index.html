<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Quest - Work Edition</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #2d3436;
            --text-color: #e0e0e0;
            
            /* Catégories */
            --cat-deep: #ff7675;   /* Rouge doux - Concentration */
            --cat-admin: #74b9ff;  /* Bleu - Routine */
            --cat-learn: #ffeaa7;  /* Jaune - Apprentissage */
            --cat-create: #a29bfe; /* Violet - Créatif */
            
            --success-color: #00b894;
            --danger-color: #d63031;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 350px;
            background-color: var(--surface-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            transition: transform 0.3s ease;
            z-index: 10;
        }

        /* Formulaire Ajout */
        .add-task-wrapper {
            background: #222;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #333;
            border: none;
            color: white;
            border-radius: 6px;
            box-sizing: border-box; 
            outline: none;
        }
        input[type="text"]:focus { background: #3b3b3b; }

        /* Sélecteur de Catégorie (Radio Buttons stylisés) */
        .category-selector {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .cat-option {
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            transition: transform 0.2s;
        }
        .cat-option:hover { transform: scale(1.1); }
        .cat-option.selected { border-color: white; transform: scale(1.2); }
        
        /* Tooltip simple au survol */
        .cat-option::after {
            content: attr(data-label);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #aaa;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .cat-option:hover::after { opacity: 1; }

        .cat-deep { background: var(--cat-deep); }
        .cat-admin { background: var(--cat-admin); }
        .cat-learn { background: var(--cat-learn); }
        .cat-create { background: var(--cat-create); }

        /* Sélecteur d'Estimation */
        .est-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #aaa;
            font-size: 0.9rem;
        }
        .est-input {
            background: #333; color: white; border: none; padding: 5px;
            width: 50px; text-align: center; border-radius: 4px;
        }

        .add-btn {
            background: #636e72; color: white; border: none; padding: 10px;
            width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: background 0.2s;
        }
        .add-btn:hover { background: #b2bec3; color: #2d3436; }

        /* Liste des tâches */
        .task-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        
        /* Scrollbar custom */
        .task-list::-webkit-scrollbar { width: 5px; }
        .task-list::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .task-item {
            background: #3a3a3a;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 4px solid transparent; /* Couleur de catégorie ici */
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }

        .task-item:hover { background: #444; }
        .task-item.active { background: #2f2f35; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        .task-item.completed { opacity: 0.4; filter: grayscale(100%); }

        .task-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .task-title { font-weight: 500; font-size: 0.95rem; }
        
        .pomo-dots { display: flex; gap: 4px; }
        .dot {
            width: 10px; height: 10px; border-radius: 50%;
            border: 2px solid #555; box-sizing: border-box;
        }
        /* Logique des points */
        .dot.filled { background-color: #fff; border-color: #fff; } 
        .dot.excess { background-color: var(--danger-color); border-color: var(--danger-color); } 

        .check-btn {
            background: transparent; border: 1px solid #666; color: #666;
            border-radius: 50%; width: 20px; height: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .check-btn:hover { border-color: var(--success-color); color: var(--success-color); }

        /* --- MAIN AREA --- */
        .main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .timer-display { font-size: 8rem; font-weight: 200; color: var(--text-color); margin: 0; line-height: 1; }
        .current-task-display { font-size: 1.5rem; color: #888; margin-bottom: 20px; font-weight: 300; }
        .tag-badge { 
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
            font-weight: bold; color: #2d3436;
        }

        .controls { display: flex; gap: 20px; margin-top: 40px; }
        .btn-control {
            padding: 15px 40px; font-size: 1rem; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold; transition: transform 0.1s;
        }
        .btn-control:active { transform: scale(0.95); }
        
        /* --- ZEN MODE --- */
        body.zen-mode .sidebar { transform: translateX(-100%); width: 0; padding: 0; opacity: 0; }
        body.zen-mode .timer-display { color: #252525; transition: color 0.5s; }
        body.zen-mode .timer-display:hover { color: #444; }
        body.zen-mode { cursor: none; }

        .progress-bar {
            position: fixed; bottom: 0; left: 0; height: 4px; background: var(--text-color); width: 0%;
            transition: width 1s linear;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: #666; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase;">Planning</h2>
        
        <div class="add-task-wrapper">
            <input type="text" id="new-task-title" placeholder="Nouvelle tâche...">
            
            <div class="category-selector">
                <div class="cat-option cat-deep selected" data-cat="deep" data-label="Deep Work" onclick="selectCat('deep')"></div>
                <div class="cat-option cat-admin" data-cat="admin" data-label="Routine" onclick="selectCat('admin')"></div>
                <div class="cat-option cat-learn" data-cat="learn" data-label="Apprentissage" onclick="selectCat('learn')"></div>
                <div class="cat-option cat-create" data-cat="create" data-label="Créatif" onclick="selectCat('create')"></div>
            </div>

            <div class="est-selector">
                <span>Estimation (25m) :</span>
                <input type="number" id="new-task-est" value="1" min="1" max="10" class="est-input">
            </div>
            
            <button class="add-btn" onclick="addTask()">Ajouter</button>
        </div>

        <div class="task-list" id="task-list">
            </div>
    </div>

    <div class="main-area">
        <div id="active-task-ui" style="text-align: center; display: none;">
            <div class="tag-badge" id="current-tag-badge">Deep Work</div>
            <div class="current-task-display" id="current-task-label">Titre de la tâche</div>
        </div>
        
        <div style="text-align: center; display: block;" id="empty-state">
            <p style="color: #555;">Sélectionnez une tâche pour commencer</p>
        </div>

        <div class="timer-display" id="timer">25:00</div>

        <div class="controls">
            <button class="btn-control" style="background: var(--success-color); color: white;" id="btn-start" onclick="toggleTimer()">Focus</button>
            <button class="btn-control" style="background: var(--danger-color); color: white; display: none;" id="btn-stop" onclick="stopTimer()">Abandon</button>
        </div>
    </div>

    <div class="progress-bar" id="progress-bar"></div>

    <script>
        /* --- CONFIG --- */
        const DURATION = 25 * 60; 
        // const DURATION = 3; // Test
        
        const CATEGORIES = {
            'deep': { color: '#ff7675', label: 'Deep Work' },
            'admin': { color: '#74b9ff', label: 'Routine' },
            'learn': { color: '#ffeaa7', label: 'Étude' },
            'create': { color: '#a29bfe', label: 'Créatif' }
        };

        /* --- STATE --- */
        let tasks = [];
        let activeTaskId = null;
        let selectedCategory = 'deep'; // Par défaut
        let timerInterval = null;
        let timeLeft = DURATION;

        /* --- INIT --- */
        function init() {
            const saved = localStorage.getItem('focusTasks_v2');
            if (saved) tasks = JSON.parse(saved);
            renderTasks();
        }

        /* --- CATÉGORIES --- */
        function selectCat(catKey) {
            selectedCategory = catKey;
            // Visuel sélection
            document.querySelectorAll('.cat-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.cat-option[data-cat="${catKey}"]`).classList.add('selected');
        }

        /* --- TÂCHES --- */
        function addTask() {
            const titleInput = document.getElementById('new-task-title');
            const estInput = document.getElementById('new-task-est');
            
            if (!titleInput.value.trim()) return;

            const newTask = {
                id: Date.now(),
                title: titleInput.value,
                cat: selectedCategory,
                estimated: parseInt(estInput.value),
                completedPomodoros: 0,
                isDone: false
            };

            tasks.push(newTask);
            save();
            renderTasks();
            
            // Auto-select si c'est la première
            if (tasks.length === 1 || !activeTaskId) selectTask(newTask.id);

            titleInput.value = '';
            estInput.value = 1;
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';

            tasks.forEach(task => {
                const catData = CATEGORIES[task.cat];
                const isActive = activeTaskId === task.id;
                
                // Calcul des points
                let dotsHtml = '';
                const totalDots = Math.max(task.estimated, task.completedPomodoros);
                
                for(let i=0; i < totalDots; i++) {
                    let classes = 'dot';
                    if (i < task.completedPomodoros) {
                        classes += ' filled';
                        // ROUGE si on dépasse l'estimation (Indicateur Planning Fallacy)
                        if (i >= task.estimated) classes += ' excess'; 
                    }
                    // Pour les points vides (futurs), on applique la couleur de la catégorie en bordure
                    let style = (i >= task.completedPomodoros) ? `border-color: ${catData.color}` : '';
                    // Si filled, background color = cat color
                    if(classes.includes('filled') && !classes.includes('excess')) style = `background-color: ${catData.color}; border-color: ${catData.color}`;
                    
                    dotsHtml += `<div class="${classes}" style="${style}"></div>`;
                }

                const item = document.createElement('div');
                item.className = `task-item ${isActive ? 'active' : ''} ${task.isDone ? 'completed' : ''}`;
                item.style.borderLeftColor = catData.color;
                
                // Au clic sur l'item (sauf le bouton check), on sélectionne
                item.onclick = (e) => {
                    if(!e.target.classList.contains('check-btn')) selectTask(task.id);
                };

                item.innerHTML = `
                    <div class="task-top">
                        <span class="task-title">${task.title}</span>
                        <button class="check-btn" onclick="toggleDone(${task.id})">✓</button>
                    </div>
                    <div class="pomo-dots">
                        ${dotsHtml}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function selectTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task || task.isDone) return;

            activeTaskId = id;
            
            // Mise à jour UI Centrale
            document.getElementById('empty-state').style.display = 'none';
            const ui = document.getElementById('active-task-ui');
            ui.style.display = 'block';
            
            document.getElementById('current-task-label').innerText = task.title;
            const badge = document.getElementById('current-tag-badge');
            badge.innerText = CATEGORIES[task.cat].label;
            badge.style.backgroundColor = CATEGORIES[task.cat].color;

            renderTasks();
        }

        function toggleDone(id) {
            const task = tasks.find(t => t.id === id);
            task.isDone = !task.isDone;
            if (activeTaskId === id) activeTaskId = null; // Désélectionner si on finit l'active
            save();
            renderTasks();
        }

        function save() {
            localStorage.setItem('focusTasks_v2', JSON.stringify(tasks));
        }

        /* --- TIMER --- */
        function toggleTimer() {
            if (!activeTaskId) {
                alert("Sélectionne une tâche d'abord !");
                return;
            }
            
            const task = tasks.find(t => t.id === activeTaskId);
            
            // Passage en mode ZEN
            document.body.classList.add('zen-mode');
            document.getElementById('btn-start').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            
            // Couleur de la barre de progression selon la catégorie
            document.getElementById('progress-bar').style.backgroundColor = CATEGORIES[task.cat].color;

            timeLeft = DURATION;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) completeSession();
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            const p = ((DURATION - timeLeft) / DURATION) * 100;
            document.getElementById('progress-bar').style.width = `${p}%`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.body.classList.remove('zen-mode');
            resetUI();
        }

        function completeSession() {
            clearInterval(timerInterval);
            document.body.classList.remove('zen-mode');
            
            // Logique Data
            const task = tasks.find(t => t.id === activeTaskId);
            if (task) {
                task.completedPomodoros++;
                save();
            }
            
            alert(`Session terminée ! Focus sur "${task.title}" enregistré.`);
            renderTasks(); // Mettra à jour les points
            resetUI();
        }

        function resetUI() {
            timeLeft = DURATION;
            document.getElementById('timer').innerText = "25:00";
            document.getElementById('progress-bar').style.width = "0%";
            document.getElementById('btn-start').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
        }

        init();
    </script>
</body>
</html>